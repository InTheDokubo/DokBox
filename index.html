<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DokBox Teams</title>
    
    <!-- Favicon: White Box with Black Outline & 'D' -->
    <link rel="icon" href="image.png" type="image/png">
    <link rel="apple-touch-icon" href="image.png">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js" crossorigin="anonymous"></script>

    <style>
        :root {
            /* Colors */
            --sb-bg: #f0f0f0; --sb-item: #e0e0e0; --sb-active: #333; --sb-text: #333;
            --bg-color: #ffffff; --card-bg: #f9f9f9; --text-main: #333333; --text-sub: #666666;
            --border-color: #ddd; --input-bg: #fff; --input-focus-bg: #fff;
            --accent-color: #333; /* Default Accent */
            --link-color: #0066cc; --danger-color: #ff4444;
            
            /* Dimensions */
            --sidebar-width: 72px;
            --header-height: 60px;
        }
        [data-theme="dark"] {
            --sb-bg: #202225; --sb-item: #2f3136; --sb-active: #40444b; --sb-text: #dcddde;
            --bg-color: #36393f; --card-bg: #2f3136; --text-main: #dcddde; --text-sub: #b9bbbe;
            --border-color: #202225; --input-bg: #40444b; --input-focus-bg: #202225;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* --- iOS SCROLL FIX (Critical Update) --- */
        html, body {
            height: 100%; width: 100%;
            margin: 0; padding: 0;
            overflow: hidden; /* Disable default scroll */
            position: fixed; /* Force fix layout on iOS */
            overscroll-behavior: none; /* Prevent bounce */
            font-family: "M PLUS Rounded 1c", sans-serif;
            background: var(--bg-color); color: var(--text-main);
            transition: background 0.3s, color 0.3s;
        }

        /* --- LOADING --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.3s;
        }
        #loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loader-scene { width: 40px; height: 40px; perspective: 400px; margin-bottom: 20px; }
        .loader-cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; animation: loaderSpin 2s infinite linear; }
        .lf { position: absolute; width: 40px; height: 40px; border: 2px solid #333; background: transparent; }
        .lf-f { transform: translateZ(20px); } .lf-b { transform: rotateY(180deg) translateZ(20px); }
        .lf-r { transform: rotateY(90deg) translateZ(20px); } .lf-l { transform: rotateY(-90deg) translateZ(20px); }
        .lf-t { transform: rotateX(90deg) translateZ(20px); } .lf-bt { transform: rotateX(-90deg) translateZ(20px); }
        @keyframes loaderSpin { 0% { transform: rotateX(0deg) rotateY(0deg); } 100% { transform: rotateX(360deg) rotateY(360deg); } }
        .loading-text { font-family: 'Arial Black', sans-serif; font-weight: 900; color: #333; letter-spacing: 1px; font-size: 1.2rem; animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { opacity: 0.6; } to { opacity: 1; } }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s;
            /* Allow internal scroll if content overflows vertically on small screens, but prevent body bounce */
            overflow-y: auto; overscroll-behavior: contain;
        }
        #login-screen.fade-out { opacity: 0; visibility: hidden; pointer-events: none; }

        .entrance-wrapper { display: flex; flex-direction: column; align-items: center; width: 100%; padding-bottom: 10vh; }
        .scene { width: 80px; height: 80px; perspective: 800px; margin-bottom: 20px; }
        .cage { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transform: rotateX(-20deg) rotateY(45deg); animation: cageSpin 12s infinite linear; }
        .face { position: absolute; width: 80px; height: 80px; border: 3px solid #333; background: #fff; opacity: 1; }
        .front { transform: translateZ(40px); } .back { transform: rotateY(180deg) translateZ(40px); }
        .right { transform: rotateY(90deg) translateZ(40px); } .left { transform: rotateY(-90deg) translateZ(40px); }
        .bottom { transform: rotateX(-90deg) translateZ(40px); background: #eee; }
        .lid-real-L { position: absolute; top: -40px; left: 0; width: 80px; height: 40px; transform-origin: bottom; border: 3px solid #333; background: #fff; transform: rotateX(90deg); animation: openLid 2.5s cubic-bezier(0.4, 0, 0.2, 1) forwards 0.5s; }
        .lid-real-R { position: absolute; top: -40px; left: 0; width: 80px; height: 40px; transform-origin: bottom; border: 3px solid #333; background: #fff; transform: rotateX(90deg); animation: openLid 2.5s cubic-bezier(0.4, 0, 0.2, 1) forwards 0.5s; }
        .lid-left-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotateY(-90deg) translateZ(40px); pointer-events: none; transform-style: preserve-3d; }
        .lid-right-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotateY(90deg) translateZ(40px); pointer-events: none; transform-style: preserve-3d; }
        @keyframes openLid { 0% { transform: rotateX(90deg); } 100% { transform: rotateX(-120deg); } }
        @keyframes cageSpin { 0% { transform: rotateX(-15deg) rotateY(0deg); } 100% { transform: rotateX(-15deg) rotateY(360deg); } }
        .entrance-logo { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%) scale(0) translateY(20px); font-family: 'Arial Black', sans-serif; font-size: 3rem; font-weight: 900; color: #333; letter-spacing: 2px; animation: logoRise 2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards 1s; z-index: 50; white-space: nowrap; }
        @keyframes logoRise { 0% { transform: translate(-50%, -50%) scale(0) translateY(50px); opacity: 0; } 100% { transform: translate(-50%, -180%) scale(1) translateY(0); opacity: 1; } }
        .login-form-wrap { opacity: 0; animation: fadeIn 1s forwards 2s; width: 90%; max-width: 280px; display: flex; flex-direction: column; gap: 15px; z-index: 200; }
        @keyframes fadeIn { to { opacity: 1; } }
        .l-input-group { position: relative; }
        .l-input { width: 100%; padding: 12px 12px 12px 36px; background: #f9f9f9; border: 2px solid #333; border-radius: 0; color: #333; font-size: 1rem; font-weight: bold; outline: none; transition: 0.3s; }
        .l-input:focus { background: #fff; border-color: #000; box-shadow: 4px 4px 0 rgba(0,0,0,0.1); }
        .l-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #333; }
        .l-btn { width: 100%; padding: 12px; background: #333; color: white; font-weight: bold; border: none; border-radius: 0; cursor: pointer; font-size: 0.9rem; text-transform: uppercase; transition: 0.2s; }
        .l-btn:hover { background: #000; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .l-toggle { text-align: center; color: #666; font-size: 0.8rem; cursor: pointer; text-decoration: underline; }
        .l-error { color: #ff4444; font-size: 0.8rem; text-align: center; margin-bottom: 5px; min-height: 1.2em; font-weight: bold; }

        /* --- APP CONTAINER --- */
        #app-container {
            display: grid; width: 100vw; height: 100%;
            grid-template-columns: 1fr; /* Sidebar is overlay on mobile */
            grid-template-rows: 100%;
            opacity: 0; display: none;
        }
        #app-container.visible { opacity: 1; display: block; }
        
        /* Sidebar (Drawer) */
        #sidebar {
            position: fixed; top: 0; left: 0; height: 100%; width: var(--sidebar-width);
            background: var(--sb-bg); display: flex; flex-direction: column; align-items: center; 
            padding-top: 15px; gap: 12px; 
            overflow-y: auto; overscroll-behavior: contain; /* Safe internal scroll */
            z-index: 3000;
            border-right: 1px solid rgba(0,0,0,0.1);
            transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 4px 0 15px rgba(0,0,0,0.15);
        }
        #sidebar.open { transform: translateX(0); }
        
        /* Sidebar Backdrop */
        #sidebar-backdrop {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2900; opacity: 0; transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }
        #sidebar-backdrop.open { display: block; opacity: 1; }

        .wiki-icon { width: 48px; height: 48px; border-radius: 50%; background: var(--sb-item); color: var(--sb-text); display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; transition: all 0.2s; font-size: 0.8rem; overflow: hidden; user-select: none; flex-shrink: 0; position: relative; }
        .wiki-icon:hover, .wiki-icon.active { border-radius: 12px; background: var(--accent-color); color: white; }
        .wiki-icon.add-btn { color: #333; border: 2px dashed #ccc; }
        .wiki-icon.add-btn:hover { background: #333; color: white; border-style: solid; }
        .app-logo-sb { color: #ccc; font-weight: 900; }
        .sidebar-footer { margin-top: auto; padding-bottom: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%; }

        /* Main Content */
        #main-content { position: relative; width: 100%; height: 100%; overflow: hidden; background: var(--bg-color); }

        #list-column, #detail-column {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            background: var(--bg-color);
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s;
        }
        
        body[data-view="list"] #list-column { transform: translateX(0); opacity: 1; z-index: 10; pointer-events: auto; }
        body[data-view="list"] #detail-column { transform: translateX(30%); opacity: 0; z-index: 0; pointer-events: none; }
        
        body[data-view="detail"] #list-column { transform: translateX(-30%); opacity: 0; z-index: 0; pointer-events: none; }
        body[data-view="detail"] #detail-column { transform: translateX(0); opacity: 1; z-index: 10; pointer-events: auto; }

        /* Headers */
        .column-header, .detail-header { height: var(--header-height); padding: 0 20px; display: flex; align-items: center; justify-content: space-between; background: var(--card-bg); border-bottom: 1px solid var(--border-color); flex-shrink: 0; gap: 10px; }
        .header-title-area { display: flex; align-items: center; gap: 10px; overflow: hidden; }
        .header-title { font-weight: 800; font-size: 1.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: default; }
        .wiki-edit-btn { display: flex; align-items: center; justify-content: center; width: 28px; height: 28px; color: var(--text-sub); border-radius: 4px; cursor: pointer; transition: background 0.2s; flex-shrink: 0; }
        .wiki-edit-btn:hover { background: var(--input-bg); color: var(--accent-color); }
        .menu-btn { display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-main); padding: 5px; border-radius: 50%; flex-shrink: 0; }
        .menu-btn:hover { background: var(--input-bg); }
        
        /* List View Items */
        .search-area { padding: 15px 20px; background: var(--bg-color); flex-shrink: 0; width: 100%; display: flex; justify-content: center; }
        .search-input { width: 100%; max-width: 800px; padding: 10px 15px 10px 35px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main); font-size: 1rem; outline: none; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .search-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(0,0,0,0.1); }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 16px; color: var(--text-sub); pointer-events: none; }
        
        /* SCROLL AREAS (Internal Scroll) */
        #list-scroll { 
            flex-grow: 1; overflow-y: auto; padding: 0 20px 40px 20px; 
            -webkit-overflow-scrolling: touch; overscroll-behavior: contain;
            width: 100%; display: flex; flex-direction: column; align-items: center; 
        }
        .editor-scroll { 
            flex-grow: 1; overflow-y: auto; padding: 0; 
            -webkit-overflow-scrolling: touch; overscroll-behavior: contain;
        }

        .card-grid { display: grid; gap: 10px; grid-template-columns: repeat(6, 1fr); width: 100%; max-width: 1200px; }
        .card { background: var(--card-bg); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; aspect-ratio: 1 / 1; display: flex; flex-direction: column; overflow: hidden; transition: all 0.2s; border: 2px solid transparent; position: relative; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: var(--accent-color); }
        .card.active { border-color: var(--accent-color); background: var(--input-bg); }
        .card-thumb { height: 50%; width: 100%; background-size: cover; background-position: center; background-color: var(--input-bg); flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        .card-content { padding: 8px; display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; text-align: center; justify-content: center;}
        .card-title { font-weight: bold; font-size: 0.8rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        .card-meta { font-size: 0.6rem; color: var(--text-sub); opacity: 0.7; }
        
        /* Detail View Items */
        .back-btn { display: flex; align-items: center; gap: 5px; color: var(--accent-color); font-weight: bold; cursor: pointer; padding: 5px 10px; border-radius: 6px; transition: background 0.2s; }
        .back-btn:hover { background: var(--input-bg); }
        .editor-wrapper { max-width: 900px; margin: 0 auto; min-height: 100%; background: var(--card-bg); padding: 40px; box-shadow: 0 0 40px rgba(0,0,0,0.03); display: flex; flex-direction: column; }
        input.title-input { width: 100%; font-size: 2rem; font-weight: 800; border: none; outline: none; background: transparent; color: var(--text-main); margin-bottom: 20px; padding: 0; line-height: 1.3; }
        #hybrid-editor { display: flex; flex-direction: column; gap: 8px; font-size: 1.1rem; line-height: 1.8; color: var(--text-main); font-family: monospace; outline: none; padding-bottom: 150px; }
        .line-block { min-height: 1.8em; outline: none; white-space: pre-wrap; word-break: break-all; border-radius: 4px; padding: 2px 6px; }
        .line-block:not(.editing) { cursor: text; }
        .line-block.editing { background: var(--input-bg); box-shadow: 0 0 0 2px var(--border-color); color: var(--text-main); }
        .r-bold { font-weight: 800; color: var(--text-main); background: rgba(0,0,0,0.05); padding: 0 4px; border-radius: 4px;}
        .r-tag { color: var(--accent-color); font-weight: bold; margin-right: 4px; background: rgba(88, 101, 242, 0.1); padding: 0 6px; border-radius: 4px; display: inline-block; cursor: pointer; }
        .r-link { color: var(--link-color); text-decoration: underline; cursor: pointer; font-weight: bold; }
        .r-link.is-empty { color: var(--danger-color); }
        .r-img { max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: block; margin: 10px 0; cursor: pointer; border: 2px solid transparent; transition: border 0.2s;}
        .r-img:hover { border-color: var(--accent-color); }
        #related-section { margin-top: 60px; padding-top: 20px; border-top: 2px solid var(--border-color); opacity: 0.8; }
        #related-grid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
        
        /* Utils */
        .hidden { display: none !important; }
        .controls-area { display: flex; align-items: center; gap: 10px; }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--accent-color); color: white; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.2s; flex-shrink: 0; }
        .btn-circle:hover { transform: scale(1.1); background: #000; }
        .btn-icon { background: none; border: none; cursor: pointer; color: var(--text-sub); padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background: var(--input-bg); color: var(--text-main); }
        .btn-icon.danger { color: #ff6b6b; }
        .btn-icon.danger:hover { background: #ffeeee; }
        .theme-toggle-wrap { position: relative; width: 24px; height: 24px; cursor: pointer; overflow: hidden; }
        .theme-icon { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: transform 0.5s, opacity 0.3s; stroke: var(--accent-color); fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .icon-moon { transform: rotate(90deg) scale(0.5); opacity: 0; } .icon-sun { transform: rotate(0) scale(1); opacity: 1; }
        [data-theme="dark"] .icon-sun { transform: rotate(-90deg) scale(0.5); opacity: 0; } [data-theme="dark"] .icon-moon { transform: rotate(0) scale(1); opacity: 1; }
        
        /* Popover & Modal */
        .settings-popover { position: absolute; top: 65px; right: 10px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; width: 260px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); z-index: 4000; display: flex; flex-direction: column; gap: 15px; }
        .settings-popover h3 { margin: 0; font-size: 0.95rem; color: var(--text-sub); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 5000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal { background: var(--card-bg); width: 90%; max-width: 400px; padding: 30px; border-radius: 0; border: 2px solid #333; display: flex; flex-direction: column; gap: 15px; box-shadow: 10px 10px 0 rgba(0,0,0,0.1); }
        .auth-input-in-modal { padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--input-bg); color: var(--text-main); font-size: 1rem; width: 100%; outline: none; }
        .wiki-desc-input { padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--input-bg); color: var(--text-main); font-size: 1rem; width: 100%; outline: none; }
        .btn-primary { padding: 12px; background: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-cancel { padding: 12px; background: transparent; color: var(--text-sub); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; width: 100%; }
        input[type="color"] { width: 100%; height: 40px; border: none; padding: 0; background: none; cursor: pointer; }
        #accent-color-picker { width: 100%; height: 40px; border-radius: 6px; border: 1px solid var(--border-color); overflow: hidden; }
        .col-options { display: flex; gap: 5px; background: var(--input-bg); padding: 4px; border-radius: 6px; }
        .col-option { flex: 1; text-align: center; padding: 8px 0; font-size: 0.9rem; cursor: pointer; border-radius: 4px; color: var(--text-sub); white-space: nowrap; }
        .col-option.active { background: var(--card-bg); color: var(--accent-color); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .danger-zone { border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 10px; display: flex; flex-direction: column; gap: 10px; }
        
        /* Desktop Layout (Default 3-Column is now handled by single view switch as requested in previous prompt, but Grid is kept for layout structure if needed) */
        @media (min-width: 769px) {
            #app-container {
                grid-template-columns: var(--sidebar-width) 1fr; /* Single Main Column */
            }
        }
        
        /* Mobile Layout */
        @media (max-width: 768px) {
            #app-container { display: block; position: relative; } /* Mobile sidebar handling */
            #sidebar { position: fixed; transform: translateX(-100%); transition: transform 0.3s; box-shadow: 4px 0 15px rgba(0,0,0,0.3); border-right: none; }
            #sidebar.open { transform: translateX(0); }
            #sidebar-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2900; opacity: 0; transition: opacity 0.3s; }
            #sidebar-backdrop.open { display: block; opacity: 1; }
            .card-grid { grid-template-columns: repeat(2, 1fr); }
            .editor-wrapper { padding: 20px; }
            input.title-input { font-size: 1.8rem; margin-bottom: 20px; }
        }
    </style>
</head>
<body data-view="list">

<!-- LOADING -->
<div id="loading-overlay" class="hidden">
    <div class="loader-scene"><div class="loader-cube"><div class="lf lf-f"></div><div class="lf lf-b"></div><div class="lf lf-r"></div><div class="lf lf-l"></div><div class="lf lf-t"></div><div class="lf lf-bt"></div></div></div>
    <div class="loading-text">Loading...</div>
</div>

<div id="sidebar-backdrop" onclick="app.toggleSidebar(false)"></div>

<!-- LOGIN SCREEN -->
<div id="login-screen">
    <div class="entrance-wrapper">
        <div class="scene"><div class="cage"><div class="face front"></div><div class="face back"></div><div class="face right"></div><div class="face left"></div><div class="face bottom"></div><div class="lid-left-container"><div class="lid-real-L"></div></div><div class="lid-right-container"><div class="lid-real-R"></div></div></div></div>
        <div class="entrance-logo">DokBox</div>
        <div class="login-form-wrap">
            <div class="l-input-group"><input type="text" id="auth-id" class="l-input" placeholder="User ID"><span class="l-icon"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></span></div>
            <div class="l-input-group"><input type="password" id="auth-pass" class="l-input" placeholder="Password"><span class="l-icon"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></span></div>
            <div id="auth-error" class="l-error"></div>
            <button id="auth-btn" class="l-btn" onclick="app.auth.submit()">LOGIN</button>
            <div id="auth-toggle" class="l-toggle" onclick="app.auth.toggleMode()">新規登録はこちら</div>
        </div>
    </div>
</div>

<!-- APP CONTAINER -->
<div id="app-container">
    <!-- SIDEBAR -->
    <aside id="sidebar">
        <div class="separator"></div>
        <div class="wiki-icon add-btn" onclick="app.showJoinCreateModal()" title="Wikiを追加">+</div>
        <div class="sidebar-footer">
            <div class="wiki-icon" style="background:none; color:var(--sb-text);" onclick="app.auth.logout()" title="ログアウト">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            </div>
            <div class="app-logo-sb">DokBox</div>
        </div>
    </aside>

    <!-- LIST COLUMN -->
    <section id="list-column">
        <div class="column-header">
            <div class="header-title-area">
                <div class="menu-btn" onclick="app.toggleSidebar()">
                    <svg width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </div>
                <div class="header-title" id="header-wiki-title">DokBox Teams</div>
                <div class="wiki-edit-btn" onclick="app.showWikiInfoModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                </div>
            </div>
            
            <div class="controls-area">
                <div class="theme-toggle-wrap" onclick="app.toggleTheme()">
                    <svg class="theme-icon icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    <svg class="theme-icon icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </div>
                <button class="btn-icon" onclick="app.toggleSettings()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
                <div id="settings-popover" class="settings-popover hidden">
                    <h3>設定 <span id="current-user-id" style="font-size:0.7rem; color:var(--accent-color);"></span></h3>
                    <div class="setting-item"><div class="setting-label">テーマカラー</div><input type="color" id="accent-color-picker"></div>
                    <div class="setting-item" style="margin-top:10px; border-top:1px solid var(--border-color); padding-top:10px;"><button class="btn-cancel" style="border:none; text-align:left; padding:0;" onclick="app.auth.logout()">ログアウト</button></div>
                </div>
                <button class="btn-circle" onclick="app.createNewPage()">+</button>
            </div>
        </div>
        
        <div class="search-area">
            <div style="position:relative; max-width:800px; margin:0 auto;">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="search-input" class="search-input" placeholder="ページを検索...">
            </div>
        </div>

        <div id="list-scroll">
            <div id="card-grid" class="card-grid"></div>
            <div id="empty-msg" class="hidden" style="text-align:center; margin-top:100px; color:var(--text-sub); opacity:0.6;">
                <p>ページがありません</p>
            </div>
        </div>
    </section>

    <section id="detail-column" class="empty">
        <div class="detail-header">
            <div class="back-btn" onclick="app.navigateHome()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg><span>戻る</span></div>
            <div class="detail-actions"><span id="save-status" style="font-size:0.75rem;color:var(--text-sub);"></span><button class="btn-icon danger" onclick="app.confirmDeletePage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>
        </div>
        <div class="editor-scroll"><div class="editor-wrapper"><input type="text" id="page-title" class="title-input" placeholder="タイトルなし"><div id="hybrid-editor"></div><div id="related-section" class="hidden" style="margin-top:60px;border-top:2px solid var(--border-color);padding-top:20px;"><div style="font-weight:bold;color:var(--text-sub);margin-bottom:15px;font-size:0.9rem;">関連ページ</div><div id="related-grid" class="card-grid" style="grid-template-columns:repeat(auto-fill,minmax(160px,1fr));"></div></div></div></div>
    </section>
</div>

<!-- Dialogs (Join/Create/Info) -->
<div id="join-create-modal" class="modal-overlay hidden"><div class="modal"><h2>Wiki追加</h2><div style="border-bottom:1px solid var(--border-color);padding-bottom:15px;margin-bottom:15px;"><h3 style="margin:0 0 8px 0;font-size:1rem;">参加する</h3><div style="display:flex;flex-direction:column;gap:8px;"><input type="text" id="join-id-input" class="auth-input-in-modal" placeholder="Wiki ID..."><input type="password" id="join-pass-input" class="auth-input-in-modal" placeholder="パスワード"><button class="btn-primary" onclick="app.joinWiki()">参加</button></div></div><div><h3 style="margin:0 0 8px 0;font-size:1rem;">新規作成</h3><div style="display:flex;flex-direction:column;gap:8px;"><input type="text" id="create-id-input" class="auth-input-in-modal" placeholder="希望ID"><input type="password" id="create-pass-input" class="auth-input-in-modal" placeholder="パスワード設定"><button class="btn-primary" onclick="app.createWiki()">作成</button></div></div><div id="force-logout-area" style="display:none;margin-top:15px;"><button class="btn-cancel" onclick="app.auth.logout()">ログアウトして戻る</button></div><button id="modal-close-btn" class="btn-cancel" style="margin-top:15px;" onclick="document.getElementById('join-create-modal').classList.add('hidden')">閉じる</button></div></div>
<div id="wiki-info-modal" class="modal-overlay hidden"><div class="modal"><h2>Wiki情報</h2><label style="font-size:0.8rem;font-weight:bold;">ID (共有用)</label><div style="display:flex;gap:5px;margin-bottom:10px;"><input type="text" id="info-wiki-id" class="auth-input-in-modal" readonly><button class="btn-primary" style="width:auto;" onclick="app.copyWikiId()">Copy</button></div><label style="font-size:0.8rem;font-weight:bold;">パスワード変更</label><input type="password" id="info-pass-input" class="auth-input-in-modal" placeholder="新パスワード"><label style="font-size:0.8rem;font-weight:bold;margin-top:10px;">創始者</label><input type="text" id="info-owner-display" class="auth-input-in-modal"><label style="font-size:0.8rem;font-weight:bold;margin-top:10px;">説明</label><textarea id="info-desc" class="wiki-desc-input"></textarea><label style="font-size:0.8rem;font-weight:bold;margin-top:10px;">備考</label><input type="text" id="info-notes" class="auth-input-in-modal"><div id="danger-zone-owner" class="danger-zone" style="display:none;"><button class="btn-primary" style="background:var(--danger-color);" onclick="app.deleteWiki()">Wikiを削除</button></div><div id="danger-zone-member" class="danger-zone" style="display:none;"><button class="btn-cancel" style="color:var(--danger-color);border-color:var(--danger-color);" onclick="app.leaveWiki()">脱退</button></div><div class="modal-btns" style="margin-top:20px;"><button class="btn-primary" onclick="app.saveWikiInfo()">保存</button><button class="btn-cancel" onclick="document.getElementById('wiki-info-modal').classList.add('hidden')">閉じる</button></div></div></div>

<script>
// --- FIREBASE CONFIG (EMBEDDED) ---
const firebaseConfig = {
  apiKey: "AIzaSyBBvRJbY3ceSwlrgm7CQkzNoPT9AiO-AFE",
  authDomain: "dokbox-4af2f.firebaseapp.com",
  projectId: "dokbox-4af2f",
  storageBucket: "dokbox-4af2f.firebasestorage.app",
  messagingSenderId: "188898536892",
  appId: "1:188898536892:web:cfbdafa7f2c126be800fb9"
};
try { if (typeof firebase !== 'undefined') firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
const db = firebase ? firebase.firestore() : null;
const auth = firebase ? firebase.auth() : null;
const DUMMY_DOMAIN = "@dokbox.dummy";

class Auth {
    constructor(app) {
        this.app = app; this.isRegister = false;
        auth.onAuthStateChanged(user => {
            if(user) { 
                document.getElementById('login-screen').classList.add('fade-out');
                setTimeout(() => {
                    document.getElementById('app-container').classList.add('visible');
                    // Reset grid layout
                    document.getElementById('app-container').style.display = 'grid';
                }, 500);
                this.app.init(user.uid, user.email.split('@')[0]); 
            } else { 
                // Reset to login screen
                document.getElementById('login-screen').classList.remove('fade-out');
                document.getElementById('app-container').classList.remove('visible');
                document.getElementById('app-container').style.display = 'none';
            }
        });
    }
    toggleMode() { 
        this.isRegister = !this.isRegister; 
        document.getElementById('auth-title').innerText = this.isRegister?"アカウント登録":"ログイン"; 
        document.getElementById('auth-btn').innerText = this.isRegister?"登録して開始":"ログイン";
        document.getElementById('auth-toggle').innerText = this.isRegister?"既存IDでログイン":"新規登録はこちら";
    }
    submit() {
        // Show loading
        document.getElementById('loading-overlay').classList.remove('hidden');
        const id=document.getElementById('auth-id').value.trim(), pass=document.getElementById('auth-pass').value.trim();
        if(!id.match(/^[a-zA-Z0-9_]+$/)) { document.getElementById('loading-overlay').classList.add('hidden'); return document.getElementById('auth-error').innerText="IDは英数字のみです"; }
        if(pass.length<6) { document.getElementById('loading-overlay').classList.add('hidden'); return document.getElementById('auth-error').innerText="パスワードは6文字以上です"; }
        const p = this.isRegister ? auth.createUserWithEmailAndPassword(id+DUMMY_DOMAIN,pass) : auth.signInWithEmailAndPassword(id+DUMMY_DOMAIN,pass);
        p.then(() => document.getElementById('loading-overlay').classList.add('hidden'))
         .catch(e => {
             document.getElementById('loading-overlay').classList.add('hidden');
             document.getElementById('auth-error').innerText=e.message;
         });
    }
    logout() { 
        auth.signOut().then(()=>{
            // Manually reset state instead of reload to avoid flicker
            document.getElementById('app-container').classList.remove('visible');
            document.getElementById('login-screen').classList.remove('fade-out');
            document.getElementById('auth-pass').value = '';
            // Reset Layout
            app.navigateHome();
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebar-backdrop').classList.remove('open');
        }); 
    }
}

class HybridEditor {
    constructor(container, onChange) {
        this.container = container; this.onChange = onChange; this.lines = [""];
    }
    setContent(text) {
        this.lines = text.split('\n'); if(this.lines.length===0) this.lines=[""];
        this.renderAll();
    }
    renderAll() {
        this.container.innerHTML = '';
        this.lines.forEach((text, i) => {
            const div = document.createElement('div'); div.className='line-block'; div.contentEditable=true;
            div.innerHTML = this.parse(text);
            div.addEventListener('focus', ()=>this.onFocus(i,div));
            div.addEventListener('blur', ()=>this.onBlur(i,div));
            div.addEventListener('input', ()=>this.onInput(i,div));
            div.addEventListener('keydown', (e)=>this.onKey(e,i));
            this.container.appendChild(div);
        });
    }
    parse(t) {
        if(!t) return '<br>';
        let h = t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
        h = h.replace(/\[(https?:\/\/.*?\.(?:png|jpg|jpeg|gif|webp)|https?:\/\/gyazo\.com\/[^\]]+)\]/gi, (m,u)=>{
            let s=u; if(s.match(/gyazo/)) s=s.replace('gyazo.com','i.gyazo.com')+'.png';
            return `<img class="r-img" src="${s}">`;
        });
        h = h.replace(/\*\*(.*?)\*\*/g, '<span class="r-bold">$1</span>')
             .replace(/#(\S+)/g, '<span class="r-tag" data-tag="$1">$1</span>')
             .replace(/\[([^\[\]]+)\]/g, (m,c) => c.startsWith('<img')?m:`<span class="r-link" data-link="${c}">[${c}]</span>`);
        return h;
    }
    onFocus(i, div) { div.classList.add('editing'); div.innerText=this.lines[i]; }
    onBlur(i, div) { div.classList.remove('editing'); this.lines[i]=div.innerText.replace(/\n/g,''); div.innerHTML=this.parse(this.lines[i]); this.onChange(this.lines.join('\n')); }
    onInput(i, div) { this.lines[i]=div.innerText.replace(/\n/g,''); window.app.triggerSave(); }
    onKey(e, i) {
        if(e.key==='Enter') {
            e.preventDefault(); this.lines.splice(i+1,0,""); this.renderAll();
            const n=this.container.children[i+1]; if(n) n.focus(); this.onChange(this.lines.join('\n'));
        } else if(e.key==='Backspace' && this.lines[i]==='' && this.lines.length>1) {
            e.preventDefault(); this.lines.splice(i,1); this.renderAll();
            const p=this.container.children[i-1]; if(p){ p.focus(); } 
            this.onChange(this.lines.join('\n'));
        }
    }
}

class App {
    constructor() {
        this.auth = new Auth(this);
        this.settings = { theme:'light', accentColor:'#333' };
        this.editor = new HybridEditor(document.getElementById('hybrid-editor'), t=>this.saveContent(t));
        this.els = { title: document.getElementById('page-title') };
        this.els.title.addEventListener('input', () => this.triggerSave());
        document.getElementById('hybrid-editor').addEventListener('click', e => {
            if(e.target.classList.contains('r-link')) {
                const t=e.target.dataset.link, p=this.pages.find(x=>x.title.toLowerCase()===t.toLowerCase());
                if(p) this.openPage(p.id); else this.createLinkedPage(t);
            }
            if(e.target.classList.contains('r-tag')) {
                document.getElementById('search-input').value=e.target.dataset.tag; this.renderList(e.target.dataset.tag); this.navigateHome();
            }
        });
        document.getElementById('search-input').addEventListener('input', e=>this.renderList(e.target.value));
        document.addEventListener('click', e => { if (!e.target.closest('.controls-area')) document.getElementById('settings-popover').classList.add('hidden'); });
        
        // Color Picker Fix
        const cp = document.getElementById('accent-color-picker');
        cp.addEventListener('input', (e)=>this.setAccentColor(e.target.value));
        cp.addEventListener('change', ()=>this.saveSettings());
    }

    async init(uid, displayId) {
        this.uid=uid; this.displayId=displayId;
        document.getElementById('current-user-id').innerText=displayId;
        this.currentWikiId = null; 
        
        db.collection('users').doc(uid).onSnapshot(d=>{ if(d.exists&&d.data().settings) { this.settings={...this.settings,...d.data().settings}; this.applySettings(); }});
        db.collection('users').doc(uid).collection('joinedWikis').orderBy('joinedAt','asc').onSnapshot(snap => {
            document.querySelectorAll('.wiki-icon-item').forEach(e=>e.remove());
            let c=0, f=null; const sep=document.querySelector('.separator');
            snap.forEach(d=>{
                const id=d.id, data=d.data();
                const el=document.createElement('div'); el.className=`wiki-icon wiki-icon-item ${this.currentWikiId===id?'active':''}`;
                el.innerText=(data.name||id).substring(0,2).toUpperCase(); el.id=`i-${id}`; el.onclick=()=>this.switchWiki(id);
                document.getElementById('sidebar').insertBefore(el,sep);
                if(c===0)f=id; c++;
            });
            if(c>0 && !this.currentWikiId) this.switchWiki(f); 
            else if(c===0) this.showJoinCreateModal(true); // Force Modal if no wikis
        });
    }

    switchWiki(id) {
        this.currentWikiId=id; document.querySelectorAll('.wiki-icon').forEach(e=>e.classList.remove('active'));
        const ic=document.getElementById(`i-${id}`); if(ic) ic.classList.add('active');
        document.getElementById('header-wiki-title').innerText=id;
        this.navigateHome();
        if(this.unsub) this.unsub();
        this.unsub = db.collection('wikis').doc(id).collection('pages').onSnapshot(s=>{
            this.pages=[]; s.forEach(d=>this.pages.push({id:d.id,...d.data()}));
            this.renderList(document.getElementById('search-input').value);
        });
        
        document.getElementById('join-create-modal').classList.add('hidden');
    }

    toggleSidebar(show) {
        const sb=document.getElementById('sidebar'), bd=document.getElementById('sidebar-backdrop');
        if(show === undefined) show = !sb.classList.contains('open'); // Toggle
        if(show){ sb.classList.add('open'); bd.classList.add('open'); } else { sb.classList.remove('open'); bd.classList.remove('open'); }
    }
    navigateHome() { this.currentPageId=null; document.body.setAttribute('data-view','list'); document.querySelectorAll('.card').forEach(c=>c.classList.remove('active')); }
    createNewPage() { this._create(''); }
    createLinkedPage(t) { this._create(t); }
    _create(t) {
        if(!this.currentWikiId) return;
        const id=Date.now().toString(36);
        const d={title:t, lines:[''], updatedAt:Date.now(), updatedBy:this.displayId};
        db.collection('wikis').doc(this.currentWikiId).collection('pages').doc(id).set(d);
        this.openPage(id, d);
    }
    openPage(id, data=null) {
        const p = data || this.pages.find(x=>x.id===id); if(!p) return;
        this.currentPageId=id;
        document.body.setAttribute('data-view','detail');
        this.els.title.value=p.title;
        this.editor.setContent(p.lines.join('\n'));
        this.renderRelated(p.title, p.lines.join('\n'));
    }
    saveContent(txt) { this.triggerSave(); this.renderRelated(this.els.title.value, txt); }
    triggerSave() {
        document.getElementById('save-status').innerText="Typing..."; clearTimeout(this.st);
        this.st = setTimeout(() => {
            if(!this.currentWikiId||!this.currentPageId) return;
            db.collection('wikis').doc(this.currentWikiId).collection('pages').doc(this.currentPageId).set({
                title: this.els.title.value, lines: this.editor.lines, updatedAt: Date.now(), updatedBy: this.displayId
            },{merge:true});
            document.getElementById('save-status').innerText="Saved";
        }, 1000);
    }
    renderList(q="") {
        const grid=document.getElementById('card-grid'); grid.innerHTML='';
        let list=[...this.pages].sort((a,b)=>b.updatedAt-a.updatedAt);
        if(q) list=list.filter(p=>(p.title||"").toLowerCase().includes(q.toLowerCase()));
        if(list.length===0) document.getElementById('empty-msg').classList.remove('hidden');
        else document.getElementById('empty-msg').classList.add('hidden');
        list.forEach(p=>{
            const el=document.createElement('div'); el.className='card';
            let th=''; const m=p.lines.join('\n').match(/\[(https?:\/\/.*?\.(?:png|jpg|jpeg|gif|webp)|https?:\/\/gyazo\.com\/[^\]]+)\]/i);
            if(m){ let u=m[1]; if(u.match(/gyazo/)) u=u.replace('gyazo.com','i.gyazo.com')+'.png'; th=`<div class="card-thumb" style="background-image:url('${u}')"></div>`; }
            el.innerHTML=`${th}<div class="card-content"><div class="card-title">${this.esc(p.title||'Untitled')}</div><div class="card-meta">by ${this.esc(p.updatedBy)}</div></div>`;
            el.onclick=()=>this.openPage(p.id);
            grid.appendChild(el);
        });
    }
    renderRelated(t, txt) {
        const grid=document.getElementById('related-grid'); grid.innerHTML='';
        const links=[]; let m; const re=/\[([^\[\]]+)\]|#(\S+)/g;
        while((m=re.exec(txt))!==null) links.push((m[1]||m[2]).toLowerCase());
        const rel = this.pages.filter(p=>{
            if(p.id===this.currentPageId) return false;
            const pt=p.title.toLowerCase(), pb=p.lines.join('\n').toLowerCase();
            return links.includes(pt) || pb.includes(`[${t.toLowerCase()}]`) || links.some(l=>pb.includes(`[${l}]`)||pb.includes(`#${l}`));
        });
        if(rel.length>0) {
            document.getElementById('related-section').classList.remove('hidden');
            rel.forEach(p=>{
                const el=document.createElement('div'); el.className='card';
                el.innerHTML=`<div class="card-content"><div class="card-title">${this.esc(p.title)}</div></div>`;
                el.onclick=()=>this.openPage(p.id);
                grid.appendChild(el);
            });
        } else { document.getElementById('related-section').classList.add('hidden'); }
    }
    
    toggleSettings(){ document.getElementById('settings-popover').classList.toggle('hidden'); }
    applySettings(){
        document.documentElement.setAttribute('data-theme',this.settings.theme); // Apply to HTML tag for CSS var inheritance
        document.documentElement.style.setProperty('--accent-color',this.settings.accentColor);
        document.getElementById('accent-color-picker').value=this.settings.accentColor;
    }
    saveSettings(){ if(this.uid) db.collection('users').doc(this.uid).set({settings:this.settings},{merge:true}); }
    setAccentColor(c){ this.settings.accentColor=c; this.applySettings(); }
    toggleTheme(){ this.settings.theme=this.settings.theme==='light'?'dark':'light'; this.applySettings(); this.saveSettings(); }
    
    showJoinCreateModal(forced = false){ 
        const m = document.getElementById('join-create-modal');
        const cBtn = document.getElementById('modal-close-btn');
        const lArea = document.getElementById('force-logout-area');
        m.classList.remove('hidden'); 
        this.toggleSidebar(false); 
        if(forced) { cBtn.style.display = 'none'; lArea.style.display = 'block'; } else { cBtn.style.display = 'block'; lArea.style.display = 'none'; }
    }
    showWikiInfoModal(){ 
        if(!this.currentWikiId)return; document.getElementById('wiki-info-modal').classList.remove('hidden');
        document.getElementById('info-wiki-id').value=this.currentWikiId;
        db.collection('wikis').doc(this.currentWikiId).get().then(d=>{
            const da=d.data()||{};
            document.getElementById('info-desc').value=da.description||'';
            document.getElementById('info-notes').value=da.notes||'';
            document.getElementById('info-owner-display').value=da.ownerName||'';
            document.getElementById('info-pass-input').value=''; 
            const isOwner = da.owner === this.uid;
            document.getElementById('danger-zone-owner').style.display=isOwner?'flex':'none';
            document.getElementById('danger-zone-member').style.display=isOwner?'none':'flex';
        });
    }
    saveWikiInfo(){
        const pass = document.getElementById('info-pass-input').value.trim();
        const data = { description:document.getElementById('info-desc').value, notes:document.getElementById('info-notes').value, ownerName:document.getElementById('info-owner-display').value };
        if(pass) data.password = pass;
        db.collection('wikis').doc(this.currentWikiId).set(data,{merge:true}).then(()=>{ alert('保存しました'); document.getElementById('wiki-info-modal').classList.add('hidden'); });
    }
    copyWikiId(){ 
        const val = this.currentWikiId;
        if(!val)return;
        const t = document.createElement("textarea"); t.value = val; t.style.position="fixed"; t.style.left="-9999px"; document.body.appendChild(t); t.focus(); t.select();
        try { document.execCommand('copy'); alert('IDをコピーしました'); } catch(e){ prompt("コピー:", val); }
        document.body.removeChild(t);
    }
    async createWiki(){
        const id=document.getElementById('create-id-input').value.trim();
        const pass=document.getElementById('create-pass-input').value.trim();
        if(!id.match(/^[a-zA-Z0-9_-]+$/)) return alert('英数字のみ');
        if(!pass) return alert('パスワード必須');
        let tid=id, ex=true, s=0;
        while(ex){ const d=await db.collection('wikis').doc(tid).get(); if(d.exists){s=Math.floor(Math.random()*9000)+1000; tid=`${id}-${s}`;}else{ex=false;}}
        const b=db.batch(); 
        b.set(db.collection('wikis').doc(tid),{owner:this.uid, password:pass, createdAt:Date.now()});
        b.set(db.collection('users').doc(this.uid).collection('joinedWikis').doc(tid),{name:tid,role:'owner',joinedAt:Date.now()});
        await b.commit(); document.getElementById('join-create-modal').classList.add('hidden');
    }
    async joinWiki(){
        const id=document.getElementById('join-id-input').value.trim(); 
        const pass=document.getElementById('join-pass-input').value.trim();
        if(!id || !pass) return alert('IDとパスワード必須');
        const d=await db.collection('wikis').doc(id).get(); if(!d.exists) return alert('なし');
        const data = d.data();
        if(pass !== (data.password || 'PrePass')) return alert('パスワード違い');
        await db.collection('users').doc(this.uid).collection('joinedWikis').doc(id).set({name:id,role:'member',joinedAt:Date.now()});
        document.getElementById('join-create-modal').classList.add('hidden');
    }
    async deleteWiki() {
        if(!confirm("本当に削除しますか？\nページデータも全て削除されます。")) return;
        const pagesRef = db.collection('wikis').doc(this.currentWikiId).collection('pages');
        let hasPages = true;
        while(hasPages) {
            const snap = await pagesRef.limit(400).get();
            if(snap.empty) hasPages = false;
            else { const batch = db.batch(); snap.forEach(doc => batch.delete(doc.ref)); await batch.commit(); }
        }
        const b = db.batch();
        b.delete(db.collection('wikis').doc(this.currentWikiId));
        b.delete(db.collection('users').doc(this.uid).collection('joinedWikis').doc(this.currentWikiId));
        await b.commit(); alert("削除しました"); location.reload();
    }
    leaveWiki() {
        if(!confirm("脱退しますか？")) return;
        db.collection('users').doc(this.uid).collection('joinedWikis').doc(this.currentWikiId).delete().then(()=>{alert("脱退しました");location.reload();});
    }
    confirmDeletePage(){
        if(confirm("ページを削除しますか？")){
            db.collection('wikis').doc(this.currentWikiId).collection('pages').doc(this.currentPageId).delete()
            .then(()=>{ this.navigateHome(); this.renderList(document.getElementById('search-input').value); });
        }
    }
    esc(s){ return s?s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"): ''; }
}

window.app = new App();
</script>
</body>
</html>


